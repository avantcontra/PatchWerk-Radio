#!/bin/sh

if [ -z "$1" ] ; then
    env=development
else
    env=$1
fi

if [ $env = "master" ] ; then
    BINDIR=/usr/local/sbin/PatchWerk
    LOGDIR=/var/log/PatchWerk
    PATCHDIR=/var/PatchWerk/patches
    TMPDIR=/var/PatchWerk/temp
    BRANCH=master
    CONFIG=config.cfg
else
    BINDIR=/usr/local/sbin/PatchWerkTest
    LOGDIR=/var/log/PatchWerkTest
    PATCHDIR=/var/PatchWerkTest/patches
    TMPDIR=/var/PatchWerkTest/temp
    BRANCH=development
    CONFIG=testconfig.cfg
fi


if [ ! -d $LOGDIR ]
then
    mkdir $LOGDIR
fi
chown logger:logging $LOGDIR

cd PatchWerk-Radio
sudo -u guy git checkout $BRANCH

cd ../Radio-Patches
sudo -u guy git checkout master

cd ..

rm -r $BINDIR
mkdir -p $BINDIR
cp -r PatchWerk-Radio/Radio.py   $BINDIR/
cp -r PatchWerk-Radio/master     $BINDIR/
cp -r PatchWerk-Radio/Pd         $BINDIR/
cp -r PatchWerk-Radio/config.cfg $BINDIR/


chmod 754 $BINDIR/Radio.py
chown -R patchwerk:radio $BINDIR

if [ -f ./$CONFIG ]
then
    echo using the config file here
    rm  $BINDIR/config.cfg
    cp  ./$CONFIG $BINDIR/
fi

rm -r $PATCHDIR
mkdir -p $PATCHDIR
cp -r ./Radio-Patches/* $PATCHDIR/
rm -r $PATCHDIR/README
chown -R patchwerk:radio $PATCHDIR
chmod -R 664 $PATCHDIR


rm -r $TMPDIR
mkdir -p $TMPDIR
chown patchwerk:radio $TMPDIR
chmod 664 $TMPDIR

